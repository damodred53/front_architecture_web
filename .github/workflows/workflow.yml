name: workflow.yml

on:
  push:
    branches:
      - main
      - Ajout-ci-cd
  pull_request:
    branches:
      - main
      - Ajout-ci-cd

env:
  VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}

jobs:
  setup:
    name: Setup & Cache
    runs-on: ubuntu-latest
    outputs:
      node-version: ${{ steps.node.outputs.node-version }}
    steps:
      - uses: actions/checkout@v4
      - id: node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install deps
        run: npm ci

  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest
    needs: setup
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint

  typecheck:
    name: Type Check (tsc)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: |
          # Type-check sans émettre
          npx tsc --noEmit

  test:
    name: Unit Tests (Vitest)
    runs-on: ubuntu-latest
    needs: [setup, lint, typecheck]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Run Vitest
        run: npm run test -- --run --coverage
      - name: Upload coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage
            coverage/**/*
          if-no-files-found: ignore

  audit:
    name: Vulnerability Scan (npm audit)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: npm audit (fail on high)
        run: |
          # Échoue si vulnérabilité >= high
          npm audit --audit-level=high --omit=dev

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, audit]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - name: Build app (Vite)
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: |
            dist
          if-no-files-found: error